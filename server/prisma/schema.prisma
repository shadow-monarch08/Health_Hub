// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  name                  String?
  passwordHash          String?
  emailVerified         Boolean   @default(false)
  verificationToken     String?
  verificationExpiresAt DateTime?
  resetToken            String?
  resetExpiresAt        DateTime?
  createdAt             DateTime  @default(now())

  onboardingCompleted Boolean   @default(false)
  profiles            Profile[]
}

model Profile {
  id           String    @id @default(uuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  displayName  String
  legalName    String?
  dob          DateTime? @db.Date
  relationship String?
  createdAt    DateTime  @default(now())

  emrConnections                 ProfileEmrConnection[]
  profileFhirResourceRaws        ProfileFhirResourceRaw[]
  profileFhirResourceNormalizeds ProfileFhirResourceNormalized[]
  profileFhirResourceCleans      ProfileFhirResourceClean[]
  profileSummaries               ProfileSummary[]
  profileSyncJobs                ProfileSyncJob[]

  @@map("profiles")
}

model ProfileEmrConnection {
  id                    String    @id @default(uuid())
  profileId             String
  profile               Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  provider              String
  patientEmrId          String
  accessTokenEncrypted  String
  refreshTokenEncrypted String?
  expiresAt             DateTime?
  scope                 String?
  status                String    @default("connected")
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @default(now()) @updatedAt

  @@unique([profileId, provider])
  @@map("profile_emr_connections")
}

model ProfileFhirResourceRaw {
  id           String   @id @default(uuid())
  profileId    String
  profile      Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  provider     String
  resourceType String
  resourceId   String
  resourceJson Json
  fetchedAt    DateTime @default(now()) @db.Timestamptz

  @@unique([profileId, provider, resourceType, resourceId])
  @@map("profile_fhir_resources_raw")
}

model ProfileFhirResourceNormalized {
  id             String   @id @default(uuid())
  profileId      String
  profile        Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  provider       String
  resourceType   String
  resourceId     String
  canonicalCode  String? // SNOMED, LOINC, RxNorm
  normalizedJson Json
  normalizedAt   DateTime @default(now()) @db.Timestamptz

  @@unique([profileId, provider, resourceType, resourceId])
  @@map("profile_fhir_resources_normalized")
}

model ProfileFhirResourceClean {
  id           String   @id @default(uuid())
  profileId    String
  profile      Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  resourceType String
  cleanJson    Json
  sources      Json // [{ provider, raw_id }]
  createdAt    DateTime @default(now()) @db.Timestamptz

  @@unique([profileId, resourceType])
  @@map("profile_fhir_resources_clean")
}

model ProfileSummary {
  profileId   String    @id
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  summaryJson Json?
  status      String    @default("absent") // absent | syncing | ready | error
  updatedAt   DateTime? @db.Timestamptz

  @@map("profile_summary")
}

model ProfileSyncJob {
  id          String    @id @default(uuid())
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  status      String    @default("pending") // pending | syncing | success | failed
  startedAt   DateTime  @default(now()) @db.Timestamptz
  completedAt DateTime? @db.Timestamptz
  error       String?

  @@map("profile_sync_jobs")
}
